<!doctype html>
<title>The Forest of Lyrica</title>
<link rel="stylesheet" href="Lyrica.css">

<div id="stage">
  <h1>The Forest of Lyrica</h1>
  <img src="" width="300" height="267">
  <p id="output"></p>
  <input id="input" type="text" placeholder="Enter your action..."> 
  <button>enter</button>
</div>

<script>
var map = [];
map[0] = "An old stone keep.";
map[1] = "A deep well.";
map[2] = "A sunny glade.";
map[3] = "A sleeping dragon";
map[4] = "A narrow pathway";
map[5] = "An ancient gate";
map[6] = "The edge of a river";
map[7] = "A lonely wooden bench.";
map[8] = "An isolated cottage. Faint music comes from the inside.";

var images = [];
images[0] = "keep.png";
images[1] = "well.png";
images[2] = "glade.png";
images[3] = "dragon.png";
images[4] = "path.png";
images[5] = "gate.png";
images[6] = "river.png";
images[7] = "bench.png";
images[8] = "cottage.png";

var blockedPathMessages = [];
blockedPathMessages[0] = "It's too dangerous to move that way.";
blockedPathMessages[1] = "A mysterious force holds you back.";
blockedPathMessages[2] = "A tangle of thorns blocks your way.";
blockedPathMessages[3] = "You can't step over the dragon.";
blockedPathMessages[4] = "";
blockedPathMessages[5] = "The gate locks shut.";
blockedPathMessages[6] = "The river is too deep to cross.";
blockedPathMessages[7] = "The trees are too thick to pass.";
blockedPathMessages[8] = "You're too scared to go to that way.";

//items
var items = ["stone"];
var itemLocations = [6];
var itemsIknow = ["flute", "stone", "sword"];
var item = "";

//The items the player are carrying
var backpack = [];

//GPS Jugador
var mapLocation = 4;

//Initialize the player's input
var playersInput = "";

//Initialize the game message
var gameMessage = "";

//Actions the game understands
var actionsIKnow = ["north", "east", "south", "west", "take", "use", "drop"];
var action ="";

//The interface fields
var output = document.querySelector("#output");
var input = document.querySelector("#input");
var button = document.querySelector("button");
var image = document.querySelector("img");

button.style.cursor = "pointer";
button.addEventListener("click", clickHandler, false);

//Display the player's location
output.innerHTML = map[mapLocation];

render();


function clickHandler()
{
  playGame();
}

function playGame()
{
  //Get the player's input and convert to lowercase
  playersInput = input.value;
  playersInput = playersInput.toLowerCase();

  //Reset the variables 
  gameMessage = "";
  action = "";
  item = "";
  //Cal posar ITEM = "" tamb√© ?????
  //Figure out the player's action
  for(i=0; i < actionsIKnow.length; i++)
  {
    if(playersInput.indexOf(actionsIKnow[i]) !== -1)
    {
        action = actionsIKnow[i];
        break;
    }
  }

  for(i=0; i <itemsIknow.length; i++)
  {
    if(playersInput.indexOf(itemsIknow[i]) !== -1)
    {
        item = itemsIknow[i];
        break;
    }
  }

  switch(action)
  {
    case "north":
      if (mapLocation >= 3)
      {
          mapLocation -= 3;
      }
      else
      {
        gameMessage = blockedPathMessages[mapLocation];
      }
      break;
    case "east":
      if (mapLocation % 3 != 2)
      {
        mapLocation += 1;
      }
      else
      {
        gameMessage = blockedPathMessages[mapLocation];
      }
      break;
    case "west":
      if (mapLocation % 3 != 0)
      {
        mapLocation -= 1; //mapLocation = mapLocation - 1;
      }
      else
      {
        gameMessage = blockedPathMessages[mapLocation];
      }
      break;

    case "south":
      if (mapLocation < 6)
      {
          mapLocation += 3;
      }
      else
      {
        gameMessage = blockedPathMessages[mapLocation];
      }
      break;

    case "take":
      takeItem();
      break;

    case "drop":
      dropItem();
      break;
    
    case "use":
      useItem();
      break;

    default:
      gameMessage = "I don't undertand that";
  }

  //Render the game
  render();
}

function takeItem(){
  var itemIndexNumber = items.indexOf(item);

  if (itemIndexNumber !== -1 && itemLocations[itemIndexNumber] === mapLocation)
  {
      backpack.push(item);
      //Remove the item from the game world
      items.splice(itemIndexNumber, 1);
      itemLocations.splice(itemIndexNumber,1);

      //Display in the console for testing
      console.log("world Items : " + items);
      console.log("backpack items : " + backpack);
  }else
  {
      gameMessage = "You can't do that";
  }
}

function dropItem(){
  var backpackIndexNumber = backpack.indexOf(item);

  if(backpack.length !== 0)
  {
    if(backpackIndexNumber !== -1) {
      items.push(backpack[backpackIndexNumber]);
      itemLocations.push(mapLocation);

      backpack.splice(backpackIndexNumber, 1);

      //Only for testing purposes
      console.log("world Items : " + items);
      console.log("backpack items : " + backpack);
    }
    else
    {
        gameMessage = "You can't do that";
    }
  }
  else{
    gameMessage = ("You're not carrying anything.");
  }
}

function useItem(){
  var backpackIndexNumber = backpack.indexOf(item);

  if(backpackIndexNumber === -1)
  {
    gameMessage = " Yoe're not carrying it."
  }
  else {
    switch(item)
    {
      case "flute":
      if (mapLocation === 8)
      {
      gameMessage = "Beautiful music fills the air.";
      gameMessage += "A wizend old man steps outside "
      gameMessage += "and hands you a sword";

      //TODO : Add the sword to the world
      
      }
      else{
        gameMessage = "You try and play the flute";
        gameMessage += "but it make no sound here."
      }
      break;

      case "stone":
        if(mapLocation === 1)
        {
          gameMessage = "You drop the stone in the well.";
          gameMessage += "A magical flute appears!";
          
          //Remove the stone from the player's backpack
          backpack.splice(backpackIndexNumber, 1);

          //TODO: Add the flute to the world
        }
        else
        {
           gameMessage = "You fumble with the stone in your pocket.";
        }
      break;

      case "sword":
        if(mapLocation === 3)
        {
          gameMessage = "You swing the sword and slay the dragon! ";
          gameMessage += "You saved the forest of Lyrica!";

          //TODO Block player's controls
        }
        else
        {
           gameMessage = "You swing the sword listlessly.";
        }
      break;
    }
  }
}

function render()
{
  output.innerHTML = map[mapLocation];
  image.src = "../images/" + images[mapLocation];

  for (var i=0; i < itemLocations.length; i++)
  {
    if (mapLocation === itemLocations[i])
    {
      output.innerHTML += "<br>You see a <strong>" + items[i] + "</strong> here.";
    }
  }

  output.innerHTML += "<br><em>" + gameMessage + "</em>";

  


}
</script>
